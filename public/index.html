<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<div id="root"></div>
    <script>
      const api = {
        get (url) {
          switch (url) {
            case '/cards':
              return new Promise((resolve, reject) => {
                setTimeout(() => {
                  resolve([
                    {
                      id: 1,
                      name: 'Apple',
                      description: 'Description',
                      price: 10,
                      img: "https://images.freeimages.com/images/small-previews/845/green-apple-1320430.jpg"
                    },
                    {
                      id: 2,
                      name: 'Orange',
                      description: 'Description',
                      price: 20,
                      img: "https://ic.pics.livejournal.com/photo_by_sam/31369462/144811/144811_original.jpg",
                    },
                  ])
                },3500)
              })
          }
        }
      }

      const stream = {
        subscribe(channel, listener) {
          const match = /price-(\d+)/.exec(channel)
          if (match) {
            setInterval(() => {
              console.log("смена цен")
              listener({
                id: parseInt(match[1]),
                price: Math.round((Math.random() * 10 + 30))
              })
            }, 11000)
          }
        }
      }
      let state = {
        menu: {
          1: 'About',
          2: 'Hello',
          3: 'world',
        },
        date: new Date(),
        cards: null
      }


      function App({ state }) {
        return {
          type: 'div',
          props: {
            className: 'app'
          },
          children: [
            {
              type: Header,
              props: { menu: state.menu}
            },
            {
              type: Clock,
              props: {time: state.time}
            },
            {
              type: Cards,
              props: {cards: state.cards}
            },
            {
              type: 'h1',
              props: {
                className: 'testnode'
              },
              children: [
                'End Page'
              ]
            }
          ]
        }
      }



      function Logo () {
        return {
          type: 'img',
          props: {
            className: 'logo',
            src: 'img/logo.png',
            alt: 'логотип',
            width: 150,
            height: 75
          }
        }
       }
      function Nav(menu) {
        return {
          type: 'nav',
          props: {
            className: 'header__nav',
            children: [
              {
                type: 'ul',
                props: {
                  className: "nav__list"
                }
              }
            ]
          }
        }

        // Object.entries(menu).forEach(([id, name], index) => {
        //   const navItem = document.createElement('li')
        //   navItem.className = "nav__item"
        //
        //   const navLink = document.createElement('a')
        //   navLink.innerText = name
        //   navLink.href = id
        //
        //   navItem.append(navLink)
        //   navList.append(navItem)
        // })
        // nav.append(navList);
        //
        // return nav
        }

      function Header (menu) {
        return {
          type: 'header',
          props: {
            className: 'header',
            children: [
              {
                type: Logo
              },
              {
                type: Nav,
                props: {
                  children: [
                    menu
                  ]
                }
              }
            ]
          }
        }
      }

      // function Block (props) {
      //   return {
      //     type: 'div',
      //     props: {
      //       className: 'block',
      //       children: props.children
      //     },
      //   }
      // }


      function Clock ({time}) {
       const isDay = time.getHours() >=7 && time.getHours() <= 21
        return {
         type: 'div',
          props: {
           className: 'clock',
            children: [
              {
                type: 'span',
                props: {
                  className: 'value',
                  children: [
                    time.toLocaleString()
                  ]
                }
              },
              {
                type: 'span',
                props: {
                  className: isDay ? 'icon day' : 'icon night',
                }
              }
            ]
          }
        }
      }

      function Loading () {
        return {
            type: 'div',
            props: {
              className: 'is-loading',
              id: 0,
              name: '',
              description: '',
              price: '',
              img: '',
            }
        }
      }
        function Cards ({ cards }) {
        if (cards === null) {
         return {
           type: Loading,
           props: {}
         }
        }

        return  {
          type: 'div',
          props: {
            className: 'cards',
            children: cards.map((card) => ({
              type: Card,
              props: { card }
            }))
          }
        }
       }

        function Card ({card}) {
        return {
          type: 'article',
          key: card.id,
          props: {
            className: 'card',
            children: [
              {
                type: 'div',
                props: {
                  className:'image',
                  children: [
                    {
                      type: 'img',
                      props: {
                        src: card.img,
                        alt: card.name
                      }
                    }
                  ]
                }
              },
              {
                type: 'div',
                props: {
                  className: 'content',
                  children: [
                    {
                      type: 'div',
                      props: {
                        className: 'price',
                        children: [
                          card.price
                        ]
                      }
                    },
                    {
                     type: 'h1',
                      props: {
                       children: [
                         card.name
                       ]
                      }
                    },
                    {
                     type: 'p' ,
                      props: {
                       children: [
                         card.description
                       ]
                      }
                    }
                  ]
                }
              }
            ]
          }
        }

          // if (card.class != undefined)
          //   node.classList.add(card.class)

        }


// ##################
      // const newDom = App({ state })
      // const realDomRoot = document.getElementById('root')
      renderView(state)

      function renderView(state) {
        render(
          App({state}),
          document.getElementById('root')
        )
      }

      function render(virtualDom, realDomRoot) {
        const evaluatedVirtualDom = evaluate(virtualDom);
        const virtualDomRoot = {
          type: realDomRoot.tagName.toLowerCase(),
          props: {
            id: realDomRoot.id,
            ...realDomRoot.attributes,
            children: [
              evaluatedVirtualDom
            ]
          },
        }

        sync(virtualDomRoot, realDomRoot)
      }

      function evaluate (virtualNode) {
        if (typeof virtualNode !== 'object') {
          return virtualNode
        }
        if (typeof virtualNode.type === 'function') {
          return evaluate((virtualNode.type)(virtualNode.props))
        }

        const  props = virtualNode.props || {}
        return {
          ...virtualNode,
          props: {
            ...props,
            children: Array.isArray(props.children) ? props.children.map(evaluate) : [evaluate(props.children)]
          }
        }
      }

      function sync (virtualNode, realNode) {
        //sync element
            if (virtualNode.id !== realNode.id) {
              realNode.id == virtualNode.id
            }
            if (virtualNode.className !== realNode.className) {
              realNode.className = virtualNode.className
            }
            if (virtualNode.attributes) {
              Array.from(virtualNode.attributes).forEach((attr) => {
                realNode[attr.name] = attr.value
              })
            }

            if (virtualNode.nodeValue !== realNode.nodeValue) {
              realNode.nodeValue = virtualNode.nodeValue
            }

        //sync child nodes

        const virtualChildren = virtualNode.childNodes
        const realChildren = realNode.childNodes

        for (let i = 0; i < virtualChildren.length || i < realChildren.length; i++) {
          const virtual = virtualChildren[i]
          const real = realChildren[i]
          // Remove
          if (virtual === undefined && real !== undefined) {
            // console.log("Удалил ноду" + realNode)
            realNode.remove(real)
          }
          // Update
          if (virtual !== undefined && real !== undefined && virtual.tagName === real.tagName) {
            // console.log("Update ноду")
            sync(virtual, real)
          }
          // Replace
          if (virtual !== undefined && real !== undefined && virtual.tagName !== real.tagName) {
            // console.log("Replace ноду")
            const newReal = createRealNodeByVirtual(virtual);
            sync(virtual, newReal)
            realNode.replaceChild(newReal, real)
          }
          // Add elem
          if (virtual !== undefined && real === undefined) {
            // console.log(virtual + " ### " + real)
            const newReal = createRealNodeByVirtual(virtual);
            sync(virtual, newReal)
            realNode.appendChild(newReal)
          }
        }
      }

      function createRealNodeByVirtual(virtual) {
        let newReal
        if (virtual.nodeType === Node.TEXT_NODE) {
          newReal = document.createTextNode('')
        } else {
          newReal = document.createElement(virtual.tagName)
        }
        return newReal
      }
// #################
      setInterval(() => {
        console.log("#CLOCK UPDATE")
        state = {
          ...state,
          date: new Date()
        }
        renderView(state)
      }, 1000)

      api.get('/cards')
        .then((cards) => {
          state = {
            ...state,
            cards
          }
          const onPrice = (data) => {
            state = {
              ...state,
              cards: state.cards.map((card) => {
                if (card.id === data.id) {
                  return {
                    ...card,
                    price: data.price
                  }
                }
                return card
              })
            }
            renderView(state)
          }

          cards.forEach((card) => {
            stream.subscribe(`price-${card.id}`, onPrice)
          })

        })
        .catch((error) => {
          console.log('Ошибка' + error);
        })

      // setInterval(() => {
      //   state = {
      //     ...state,
      //     cards: state.cards.map((card) => {
      //       return {
      //         ...card,
      //         price: Math.round((Math.random()* 10 + 30))
      //       }
      //     })
      //   }
      // }, 5000)



    //
        function showTime(){
          var h = state.date.getHours(); // 0 - 23
          var m = state.date.getMinutes(); // 0 - 59
          var s = state.date.getSeconds(); // 0 - 59
          var session = "AM";

          if(h == 0){
            h = 12;
          }

          if(h > 12){
            h = h - 12;
            session = "PM";
          }

          h = (h < 10) ? "0" + h : h;
          m = (m < 10) ? "0" + m : m;
          s = (s < 10) ? "0" + s : s;

          var time = h + ":" + m + ":" + s + " " + session;
          document.getElementById("MyClockDisplay").innerText = time;
          document.getElementById("MyClockDisplay").textContent = time;

          setTimeout(showTime, 1000);

        }

    </script>
</body>
</html>