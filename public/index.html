<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="style.css">
<!--    React library-->
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
<!--    Babel library-->
    <script src="https://unpkg.com/babel-standalone@6/babel.js"></script>
<!--    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>-->
</head>
<body>


<div id="root"></div>
   <script type="text/jsx" >
      const api = {
        get(url) {
          switch (url) {
            case '/cards':
              return new Promise((resolve, reject) => {
                setTimeout(() => {
                  resolve([
                    {
                      id: 1,
                      name: 'Apple',
                      description: 'Description',
                      price: 10,
                      img: "https://images.freeimages.com/images/small-previews/845/green-apple-1320430.jpg"
                    },
                    {
                      id: 2,
                      name: 'Orange',
                      description: 'Description',
                      price: 20,
                      img: "https://ic.pics.livejournal.com/photo_by_sam/31369462/144811/144811_original.jpg",
                    },
                  ])
                },3500)
              })
          }
        }
      }

      const stream = {
        subscribe(channel, listener) {
          const match = /price-(\d+)/.exec(channel)
          if (match) {
            setInterval(() => {
              console.log("смена цен")
              listener({
                id: parseInt(match[1]),
                price: Math.round((Math.random() * 10 + 30))
              })
            }, 11000)
          }
        }
      }
      // ########Store####
      const initialState = {
        menu: {
          'About': "#" ,
          'Hello': "#" ,
          'world': "#",
        },
        date: new Date(),
        cards: null
      }

      class Store {
        constructor(initialState) {
          this.state = initialState
          this.listeners = []
        }
        subscribe(callback) {
          this.listeners.push(callback)
        }
        getState () {
          return this.state
        }
        changeState (diff) {
          this.state = {
            ...this.state,
            ...(typeof diff === 'function' ? diff(this.state) : diff)
          }
          // renderView(this.state) можно при каждом изменение стейта дергать перерендинг но будет не красиво потому что появиться привязка к коду
          this.listeners.forEach((listener) => {
            listener()
          })
        }
      }
      //   setState (state) {
      //     this.state = state
      //   }
      // }

      const store = new Store(initialState)

// #############View##################
      function App({ state }) {
        return (
          <div className="app">
            <Header menu={state.menu} />
            <Clock time={state.date} />
            <Cards cards={state.cards} />
          </div>
        )
      }

      function Header (menu) {
        return <header className="header">
          <Logo />
          <Nav menu={menu} />
        </header>
      }

      function Logo () {
        return <img className="logo" src="img/logo.png" alt="логотип" width="150" height="70" />
        // return VDom.createElement('img', {className: 'logo',src: 'img/logo.png',alt: 'логотип', width: 150, height: 70})
        }

      function Nav(menu) {
        const listmenu = menu['menu']['menu']
        return <nav className="header__nav">
          <ul className="nav__list">
            <li className="nav__item">
              <a href="#">Hello</a>
            </li>
          </ul>
        </nav>
       }

      function Clock ({time}) {
       const isDay = time.getHours() >=7 && time.getHours() <= 21
        return <div className="clock">
          <span className="value" children={time.toLocaleTimeString()}></span>
          <span className={isDay ? 'icon day' : 'icon night'}></span>
        </div>
      }

      function Loading () {
        return <div className="card is-loading">
          <div className="image">
            <img src="" alt=""/>
          </div>
          <div className="content">
           <div className="price"></div>
            <h1></h1>
            <p></p>
          </div>
        </div>
      }
        function Cards ({ cards }) {
        if (cards === null) {
            return <div className="cards">
              <Loading />
            </div>
        }
        return (
          <div className="cards">
            {
              cards.map((card) => <Card card={card} key={card.id} />)
            }
          </div>
        )
       }

        function Card ({card, key}) {
        return <article className="card" key={key+1}>
          <div className="image">
            <img src={card.img} alt={card.name}/>
          </div>
          <div className="content">
            <div className="price">{card.price}</div>
            <h1>{card.name}</h1>
            <p>{card.description}</p>
          </div>
        </article>
          }



// #################render##############




      function render(virtualDom, realDomRoot) {
        const evaluatedVirtualDom = evaluate(virtualDom);
        const virtualDomRoot = {
          type: realDomRoot.tagName.toLowerCase(),
          props: {
            id: realDomRoot.id,
            ...realDomRoot.attributes,
            children: [
              evaluatedVirtualDom
            ]
          },
        }
        sync(virtualDomRoot, realDomRoot)
      }

      function evaluate (virtualNode) {
        if (typeof virtualNode !== 'object') {
          return virtualNode
        }
        if (typeof virtualNode.type === 'function') {
          return evaluate((virtualNode.type)(virtualNode.props))
        }

        const  props = virtualNode.props || {}
        return {
          ...virtualNode,
          props: {
            ...props,
            children: Array.isArray(props.children) ? props.children.map(evaluate) : [evaluate(props.children)]
          }
        }
      }

      function sync (virtualNode, realNode) {
        //sync element
            if (virtualNode.props) {
              Object.entries(virtualNode.props).forEach(([name, value]) => {
                if (name === 'children' || name === 'key') {
                return
                }

                if (realNode[name] !== value ) {
                  realNode[name] = value
                }
              })
            }

            if (virtualNode.key) {
              realNode.dataset.key = virtualNode.key
            }

            if (typeof virtualNode !== 'object' && virtualNode !== realNode.nodeValue) {
              realNode.nodeValue = virtualNode
            }

        //sync child nodes

        const virtualChildren = virtualNode.props ? virtualNode.props.children || [] : []
        const realChildren = realNode.childNodes

        for (let i = 0; i < virtualChildren.length || i < realChildren.length; i++) {
          const virtual = virtualChildren[i]
          const real = realChildren[i]
          // Remove
          if (virtual === undefined && real !== undefined) {
            // console.log("Удалил ноду" + realNode)
            realNode.remove(real)
          }
          // Update
          if (virtual !== undefined && real !== undefined &&  (virtual.type || '') === (real.tagName || '').toLowerCase()) {
            // console.log("Update ноду")
            sync(virtual, real)
          }
          // Replace
          if (virtual !== undefined && real !== undefined && (virtual.type || '') !== (real.tagName || '').toLowerCase()) {
            // console.log("Replace ноду")
            const newReal = createRealNodeByVirtual(virtual);
            sync(virtual, newReal)
            realNode.replaceChild(newReal, real)
          }
          // Add elem
          if (virtual !== undefined && real === undefined) {
            // console.log(virtual + " ### " + real)
            const newReal = createRealNodeByVirtual(virtual);
            sync(virtual, newReal)
            realNode.appendChild(newReal)
          }
        }
      }

      function createRealNodeByVirtual(virtual) {
        if (typeof  virtual !== 'object') {
            return  document.createTextNode('')
        }
        return document.createElement(virtual.type)
      }
// #################


      function renderView(state) {
        ReactDOM.render(
          <App state={state} />,
          document.getElementById('root')
        )
      }

      store.subscribe(() => {
        renderView(store.getState())
      })

      renderView(store.getState())


      //  ######Events########
      setInterval(() => {
        store.changeState({
          date: new Date()
        })
      }, 1000)

      api.get('/cards')
        .then((cards) => {
       store.changeState({
         cards
       })

      const onPrice = (data) => {
         store.changeState(changeCardPrice(data.id, data.price))
      }

          cards.forEach((card) => {
            stream.subscribe(`price-${card.id}`, onPrice)
          })
        })
      // #######UTILS#######
       function changeCardPrice(id, price) {
        store.changeState((state) => ({
          cards: state.cards.map((card) => {
                  if (card.id === id) {
                    return {
                      ...card,
                      price: price
                    }
                  }
                  return card
                })
        }))
       }
   </script>

</body>
</html>