<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<div id="root"></div>
    <script>
      const api = {
        get (url) {
          switch (url) {
            case '/cards':
              return new Promise((resolve, reject) => {
                setTimeout(() => {
                  resolve([
                    {
                      id: 1,
                      name: 'Apple',
                      description: 'Description',
                      price: 10,
                      img: "https://images.freeimages.com/images/small-previews/845/green-apple-1320430.jpg"
                    },
                    {
                      id: 2,
                      name: 'Orange',
                      description: 'Description',
                      price: 20,
                      img: "https://ic.pics.livejournal.com/photo_by_sam/31369462/144811/144811_original.jpg",
                    },
                  ])
                },3500)
              })
          }
        }
      }

      const stream = {
        subscribe(channel, listener) {
          const match = /price-(\d+)/.exec(channel)
          if (match) {
            setInterval(() => {
              console.log("смена цен")
              listener({
                id: parseInt(match[1]),
                price: Math.round((Math.random() * 10 + 30))
              })
            }, 11000)
          }
        }
      }
      let state = {
        menu: {
          1: 'About',
          2: 'Hello',
          3: 'world',
        },
        date: new Date(),
        cards: null
      }


      function App({ state }) {
        const app = document.createElement('div')
        app.className = 'app'
        app.append(Header(state.menu))
        app.append(Clock({
          time: state.date,
        }))
        app.append(Cards({cards: state.cards}))
        return app
      }



      function Logo () {
          const logo = document.createElement('img');
          logo.classList.add('logo')
          logo.src = 'img/logo.png'
          logo.alt = 'логотип'
          logo.width = 150
          logo.height = 75
          return logo
        }
      function Nav(menu) {
        const nav = document.createElement('nav')
        nav.className = "header__nav"
        const navList = document.createElement('ul')
        navList.className = "nav__list"

        Object.entries(menu).forEach(([id, name], index) => {
          const navItem = document.createElement('li')
          navItem.className = "nav__item"

          const navLink = document.createElement('a')
          navLink.innerText = name
          navLink.href = id

          navItem.append(navLink)
          navList.append(navItem)
        })
        nav.append(navList);

        return nav
        }

      function Header (menu) {
        const header = document.createElement('header')
        header.className = 'header'
        header.append(Logo())
        header.append(Nav(menu))
        return header
      }


      function Clock ({time}) {
        const clock = document.createElement('div')
        clock.className = 'clock'
        // clock.onload = showTime

        const value = document.createElement('span')
        value.className = 'value'
        value.innerText = time.toLocaleTimeString()

       clock.append(value)

        const icon = document.createElement('span')
        if (time.getHours() >= 7 && time.getHours() <= 21) {
          icon.className = 'icon day'
        } else {
          icon.className = 'icon night'
        }

        clock.append(icon)

        return clock
      }

        function Cards ({ cards }) {
        if (cards === null) {
            const card =
              {
                id: 1,
                name: '',
                description: '',
                price: '',
                img: '',
                class: 'is-loading'
              }
         return Card({card});
        }
        const list = document.createElement('div')
        list.className = 'cards'

        cards.forEach((card) => {
          list.append(Card({card}))
            })
          return list
        }

        function Card ({card}) {

          const node = document.createElement('article')
          node.className = 'card'
          if (card.class != undefined)
            node.classList.add(card.class)

          const image = document.createElement('div')
          image.className = 'image'
          const blockImage = document.createElement('img')
          blockImage.src = card.img
          blockImage.alt = card.name
          image.append(blockImage)
          node.append(image)


          const content = document.createElement('div')
          content.className = 'content'

          const price = document.createElement('div')
          price.className = 'price'
          price.innerText = card.price

          const name = document.createElement('h1')
          name.innerText = card.name

          const description = document.createElement('p')
          description.innerText = card.description
          content.append(price)
          content.append(name)
          content.append(description)
          node.append(content)
          return node
        }


// ##################
      // const newDom = App({ state })
      // const realDomRoot = document.getElementById('root')
      renderView(state)

      function renderView(state) {
        render(
          App({state}),
          document.getElementById('root')
        )
      }

      function render(virtualDom, realDomRoot) {
        const virtualDomRoot = document.createElement(realDomRoot.tagName)
        virtualDomRoot.id = 'root'
        virtualDomRoot.append(virtualDom)

        sync(virtualDom, realDomRoot)
      }

      function sync (virtualNode, realNode) {
        //sync element
            if (virtualNode.id !== realNode.id) {
              realNode.id == virtualNode.id
            }
            if (virtualNode.className !== realNode.className) {
              realNode.className = virtualNode.className
            }
            if (virtualNode.attributes) {
              Array.from(virtualNode.attributes).forEach((attr) => {
                realNode[attr.name] = attr.value
              })
            }

            if (virtualNode.nodeValue !== realNode.nodeValue) {
              realNode.nodeValue = virtualNode.nodeValue
            }

        //sync child nodes

        const virtualChildren = virtualNode.childNodes
        const realChildren = realNode.childNodes

        for (let i = 0; i < virtualChildren.length || i < realChildren.length; i++) {
          const virtual = virtualChildren[i]
          const real = realChildren[i]
          // Remove
          if (virtual === undefined && real !== undefined) {
            // console.log("Удалил ноду" + realNode)
            realNode.remove(real)
          }
          // Update
          if (virtual !== undefined && real !== undefined && virtual.tagName === real.tagName) {
            // console.log("Update ноду")
            sync(virtual, real)
          }
          // Replace
          if (virtual !== undefined && real !== undefined && virtual.tagName !== real.tagName) {
            // console.log("Replace ноду")
            const newReal = createRealNodeByVirtual(virtual);
            sync(virtual, newReal)
            realNode.replaceChild(newReal, real)
          }
          // Add elem
          if (virtual !== undefined && real === undefined) {
            // console.log(virtual + " ### " + real)
            const newReal = createRealNodeByVirtual(virtual);
            sync(virtual, newReal)
            realNode.appendChild(newReal)
          }
        }
      }

      function createRealNodeByVirtual(virtual) {
        let newReal
        if (virtual.nodeType === Node.TEXT_NODE) {
          newReal = document.createTextNode('')
        } else {
          newReal = document.createElement(virtual.tagName)
        }
        return newReal
      }
// #################
      setInterval(() => {
        console.log("#CLOCK UPDATE")
        state = {
          ...state,
          date: new Date()
        }
        renderView(state)
      }, 5000)

      api.get('/cards')
        .then((cards) => {
          state = {
            ...state,
            cards
          }
          const onPrice = (data) => {
            state = {
              ...state,
              cards: state.cards.map((card) => {
                if (card.id === data.id) {
                  return {
                    ...card,
                    price: data.price
                  }
                }
                return card
              })
            }
            renderView(state)
          }

          cards.forEach((card) => {
            stream.subscribe(`price-${card.id}`, onPrice)
          })

        })
        .catch((error) => {
          console.log('Ошибка' + error);
        })

      // setInterval(() => {
      //   state = {
      //     ...state,
      //     cards: state.cards.map((card) => {
      //       return {
      //         ...card,
      //         price: Math.round((Math.random()* 10 + 30))
      //       }
      //     })
      //   }
      // }, 5000)



    //
        function showTime(){
          var h = state.date.getHours(); // 0 - 23
          var m = state.date.getMinutes(); // 0 - 59
          var s = state.date.getSeconds(); // 0 - 59
          var session = "AM";

          if(h == 0){
            h = 12;
          }

          if(h > 12){
            h = h - 12;
            session = "PM";
          }

          h = (h < 10) ? "0" + h : h;
          m = (m < 10) ? "0" + m : m;
          s = (s < 10) ? "0" + s : s;

          var time = h + ":" + m + ":" + s + " " + session;
          document.getElementById("MyClockDisplay").innerText = time;
          document.getElementById("MyClockDisplay").textContent = time;

          setTimeout(showTime, 1000);

        }

    </script>
</body>
</html>